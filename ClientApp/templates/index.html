<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.4.0/css/bootstrap4-toggle.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="../static/css/style.css">
    <script src="../static/src/sigma.core.js"></script>
    <script src="../static/src/conrad.js"></script>
    <script src="../static/src/utils/sigma.utils.js"></script>
    <script src="../static/src/utils/sigma.polyfills.js"></script>
    <script src="../static/src/sigma.settings.js"></script>
    <script src="../static/src/classes/sigma.classes.dispatcher.js"></script>
    <script src="../static/src/classes/sigma.classes.configurable.js"></script>
    <script src="../static/src/classes/sigma.classes.graph.js"></script>
    <script src="../static/src/classes/sigma.classes.camera.js"></script>
    <script src="../static/src/classes/sigma.classes.quad.js"></script>
    <script src="../static/src/classes/sigma.classes.edgequad.js"></script>
    <script src="../static/src/captors/sigma.captors.mouse.js"></script>
    <script src="../static/src/captors/sigma.captors.touch.js"></script>
    <script src="../static/src/renderers/sigma.renderers.canvas.js"></script>
    <script src="../static/src/renderers/sigma.renderers.webgl.js"></script>
    <script src="../static/src/renderers/sigma.renderers.svg.js"></script>
    <script src="../static/src/renderers/sigma.renderers.def.js"></script>
    <script src="../static/src/renderers/webgl/sigma.webgl.nodes.def.js"></script>
    <script src="../static/src/renderers/webgl/sigma.webgl.nodes.fast.js"></script>
    <script src="../static/src/renderers/webgl/sigma.webgl.edges.def.js"></script>
    <script src="../static/src/renderers/webgl/sigma.webgl.edges.fast.js"></script>
    <script src="../static/src/renderers/webgl/sigma.webgl.edges.arrow.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.labels.def.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.hovers.def.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.nodes.def.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.edges.def.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.edges.curve.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.edges.arrow.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.edges.curvedArrow.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.edgehovers.def.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.edgehovers.curve.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.edgehovers.arrow.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.edgehovers.curvedArrow.js"></script>
    <script src="../static/src/renderers/canvas/sigma.canvas.extremities.def.js"></script>
    <script src="../static/src/renderers/svg/sigma.svg.utils.js"></script>
    <script src="../static/src/renderers/svg/sigma.svg.nodes.def.js"></script>
    <script src="../static/src/renderers/svg/sigma.svg.edges.def.js"></script>
    <script src="../static/src/renderers/svg/sigma.svg.edges.curve.js"></script>
    <script src="../static/src/renderers/svg/sigma.svg.labels.def.js"></script>
    <script src="../static/src/renderers/svg/sigma.svg.hovers.def.js"></script>
    <script src="../static/src/middlewares/sigma.middlewares.rescale.js"></script>
    <script src="../static/src/middlewares/sigma.middlewares.copy.js"></script>
    <script src="../static/src/misc/sigma.misc.animation.js"></script>
    <script src="../static/src/misc/sigma.misc.bindEvents.js"></script>
    <script src="../static/src/misc/sigma.misc.bindDOMEvents.js"></script>
    <script src="../static/src/misc/sigma.misc.drawHovers.js"></script>
    <title>Trabalho Final de Sistema Distribuidos</title>
</head>

<body>
    <section class="row row-graph">
        <section class="col-sm-9 graph-area" id="graph-container"></section>
        <section class="col-sm-3 control-area">
            <div class="control-area-ttl">Lista de Servidores</div>
            <div class="control-area-list" id="control-area-list"></div>
            <div>
                <div class="control-area-ttl" data-toggle="collapse" data-target="#instServidor" style="cursor: pointer;">Instanciar Servidor</div>
                <div id="instServidor" class="collapse">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">ID</span>
                        </div>
                        <input type="text" class="form-control id_node" placeholder="Identificação" aria-label="id" aria-describedby="basic-addon1">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">MS</span>
                        </div>
                        <input type="number" class="form-control ms_node" placeholder="Tempo de execução" aria-label="Tempo" aria-describedby="basic-addon1">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="send_create_node()">Instanciar</button>
                </div>
                <div class="control-area-ttl" data-toggle="collapse" data-target="#msgConexao" style="cursor: pointer;">Criar Conexão</div>
                <div id="msgConexao" class="collapse">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text">Origem</label>
                        </div>
                        <select class="custom-select custom-select-node" id="cc_origem"></select>
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text">Destino</label>
                        </div>
                        <select class="custom-select custom-select-node" id="cc_destino"></select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="send_create_connection()">Conectar</button>
                    <button type="button" class="btn btn-primary" onclick="send_delete_connection()">Desconectar</button>
                </div>
                <div class="control-area-ttl" data-toggle="collapse" data-target="#msgServidor" style="cursor: pointer;">Calcular Distancia</div>
                <div id="msgServidor" class="collapse">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text">Origem</label>
                        </div>
                        <select class="custom-select custom-select-node" id="cr_origem"></select>
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text">Destino</label>
                        </div>
                        <select class="custom-select custom-select-node" id="cr_destino"></select>
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text">Algoritmos</label>
                        </div>
                        <select class="custom-select" id="cr_algoritmo">
                                <option selected></option>
                                <option value="1">Dijsktra</option>
                                <option value="2">Vizinho</option>
                            </select>
                    </div>
                    <button type="button" class="btn btn-primary">Calcular</button>
                </div>
            </div>
            <footer>
                <div style="width: 30px; float: left;">
                    <img src='../static/images/load.gif' class="img-updating hide" style="width: 30px; cursor: pointer;" title="Atualizando tela, aguarde...">
                    <img src='../static/images/load.png' class="img-update" style="width: 30px; cursor: pointer;" title="Clique para atualizar a tela" onclick="send_get_all_node()">
                </div>
                <div class="center" style="height: 26px;">
                    <span>
                        <a href="https://github.com/chsponciano/TrabFinalSD">@TrabFinalSD</a>
                    </span>
                </div>

            </footer>
        </section>
    </section>
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.4.0/js/bootstrap4-toggle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script>
        var ws = new WebSocket("ws://127.0.0.1:8765/");
        var nodes = new Map();
        var edges = new Map();
        var count_edge = 1;
        var connect_init = 0;

        ws.onmessage = function(event) {
            data = event.data.split("'").join("\"");
            console.log(data);
            var content = JSON.parse(data);
            switch (content["message"]) {
                case "get_all_nodes":
                    get_all_nodes(content);
                    break;
                case "create_node":
                    create_node(content["args"]);
                    break;
                case "delete_node":
                    delete_node(content["args"]);
                    break;
                case "create_connection":
                    create_connection(content["args"]);
                    break;
                case "delete_connection":
                    delete_connection(content["args"]);
                    break;
                case "calc_router":
                    calc_router(content["args"]);
                    break;
                case "every_node_callback_message":
                    every_node_callback_message(content["args"]);
                    break;
                case "end_algorithm_callback_message":
                    end_algorithm_callback_message(content["args"]);
                    break;
                default:
                    break;
            }
        };

        class Node {
            constructor(node_name, processing_time) {
                this.node_name = node_name;
                this.processing_time = processing_time;
            }
        }

        class Edge {
            constructor(edge_name, source, target) {
                this.edge_name = edge_name;
                this.source = source;
                this.target = target;
            }
        }

        function existEdge(source, target) {
            for (var [key, value] of edges) {
                if ((value.source == source && value.target == target) || (value.source == target && value.target == source)) {
                    return true;
                }
            }

            return false;
        }

        async function refresh_screen() {
            if (connect_init == 0) {
                connect_init = 1;
                await sleep(1000);
                console.log('auto send_get_all_node');
                send_get_all_node();
            } else {
                if (connect_init == 2) {
                    var el;

                    for (let index = 0; index < 3; index++) {
                        el = document.getElementsByTagName('canvas')[0];
                        el.parentNode.removeChild(el);
                    }
                } else {
                    connect_init = 2;
                }

                var g = {
                    nodes: [],
                    edges: []
                };

                for (var [key, value] of nodes) {
                    g.nodes.push({
                        id: key,
                        label: key,
                        x: Math.random(),
                        y: Math.random(),
                        size: 10,
                        color: '#007bff'
                    });
                }

                for (var [key, value] of edges) {
                    g.edges.push({
                        id: value.edge_name,
                        source: value.source,
                        target: value.target,
                        size: 10,
                        color: '#CCC'
                    });
                }

                s = new sigma({
                    graph: g,
                    container: 'graph-container'
                });

                list_server();

                $(".img-updating").addClass('hide');
                $(".img-update").removeClass('hide');

            }
        }

        function list_server() {
            $('#control-area-list').html('');
            $('.custom-select-node').html("<option selected></option>");
            for (var [key, value] of nodes) {
                $('#control-area-list').append('<article><div class="row"><div class="col-sm-8 ds-node"><div id="content">' + key + '<br>' + value.processing_time +
                    'ms</div></div><div class="col-sm-4 control-area-list-chk"><button type="button" class="btn btn-primary" onclick="send_delete_create(\'' + key + '\')">Excluir</button></div></div></article>');
                $('.custom-select-node').append("<option value='" + key + "'>" + key + "</option>");
            }

        }

        var get_all_nodes = function(content) {
            nodes.clear();
            edges.clear();
            count_edge = 1;

            for (let i = 0; i < content["args"]["nodes"].length; i++) {
                nodes.set(content["args"]["nodes"][i]["node_name"], new Node(content["args"]["nodes"][i]["node_name"], content["args"]["nodes"][i]["processing_time"]));

                for (let j = 0; j < content["args"]["nodes"][i]["connections"].length; j++) {
                    if (!existEdge(content["args"]["nodes"][i]["node_name"], content["args"]["nodes"][i]["connections"][j])) {
                        edges.set("e" + count_edge, new Edge("e" + count_edge, content["args"]["nodes"][i]["node_name"], content["args"]["nodes"][i]["connections"][j]));
                        count_edge++;
                    }
                }
            }

            refresh_screen();
        }

        var create_node = function(args) {
            if (!nodes.has(args.node_name)) {
                nodes.set(args.node_name, new Node(args.node_name, args.processing_time));
            }
            refresh_screen();
        }

        var delete_node = function(args) {
            if (nodes.has(args.node_name)) {
                nodes.delete(args.node_name)
            }
            refresh_screen();
        }

        var create_connection = function(args) {
            console.log(args);
            edges.set('e' + count_edge, new Edge('e' + count_edge, args.node1, args.node2));
            count_edge++;
            edges.set('e' + count_edge, new Edge('e' + count_edge, args.node1, args.node2));
            count_edge++;
            refresh_screen();
        }

        var delete_connection = function(args) {
            console.log(args);
            for (var [key, value] of edges) {
                if ((value.source == args.node1 && value.target == args.node2) || (value.source == args.node2 && value.target == args.node1)) {
                    edges.delete(key);
                }
            }
            refresh_screen();
        }

        var calc_router = function(args) {
            console.log(args);
            refresh_screen();
        }

        var end_algorithm_callback_message = function(args) {
            console.log(args);
        }

        var every_node_callback_message = function(args) {
            console.log(args);
        }

        function send_message(message) {
            $(".img-update").addClass('hide');
            $(".img-updating").removeClass('hide');
            ws.send(message);
        }

        function send_get_all_node() {
            send_message('{"message": "get_all_nodes", "args": {"callback_queue": "frontend-queue", "callback_message": "get_all_nodes"}}');
        }

        function send_create_node() {
            idx = $('.id_node').val();
            cust = $('.ms_node').val();
            send_message('{"message": "create_node", "args": {"callback_queue": "frontend-queue", "callback_message": "create_node", "node_name": "' + idx + '", "processing_time": "' + cust + '"}}');
            $('.id_node').val('');
            $('.ms_node').val('');
        }

        function send_delete_create(idx) {
            send_message('{"message": "delete_node", "args": {"callback_queue": "frontend-queue", "callback_message": "delete_node", "node_name": "' + idx + '"}}');
        }

        function send_create_connection() {
            node1 = $('#cc_origem').val();
            node2 = $('#cc_destino').val();
            send_message('{"message": "create_connection", "args": {"callback_queue": "frontend-queue", "callback_message": "create_connection", "node1": "' + node1 + '", "node2": "' + node2 + '"}}');
            $('#cc_origem').val('');
            $('#cc_destino').val('');
        }

        function send_delete_connection() {
            node1 = $('#cc_origem').val();
            node2 = $('#cc_destino').val();
            send_message('{"message": "delete_connection", "args": {"callback_queue": "frontend-queue", "callback_message": "delete_connection", "node1": "' + node1 + '", "node2": "' + node2 + '"}}');
            $('#cc_origem').val('');
            $('#cc_destino').val('');
        }

        function send_calc_route() {
            node1 = $('#cr_origem').val();
            node2 = $('#cr_destino').val();
            algorithm = $('#cr_algoritmo').val();
            send_message('{"message": "calc_route", "args": {"callback_queue": "frontend-queue", "callback_message": "calc_route", "every_node_callback_message": "every_node_callback_message", \
                           "end_algorithm_callback_message": "end_algorithm_callback_message, "start_node": "' + node1 + '", "target_node": "' + node2 + '", "algorithm" : "' + algorithm + '"}}');
            $('#cr_origem').val('');
            $('#cr_destino').val('');
        }

        $(function() {
            $("#graph-container").mouseenter(function() {
                document.querySelector('#graph-container').style.cursor = 'grab';
            });
        });

        $(function() {
            $("#graph-container").mouseout(function() {
                document.querySelector('#graph-container').style.cursor = 'default';
            });
        });

        $(function() {
            $("#graph-container").mousedown(function() {
                document.querySelector('#graph-container').style.cursor = 'grabbing';
            });
        });

        $(function() {
            $("#graph-container").mouseup(function() {
                document.querySelector('#graph-container').style.cursor = 'grab';
            });
        });

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        refresh_screen(true);
    </script>
</body>

</html>